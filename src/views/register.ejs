<div class="ath-register-container">
  <div class="ath-register-panel">
    <div class="ath-register-brand-section">
      <svg class="ath-register-brand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      </svg>
      <h1 class="ath-register-brand-title">Crear cuenta</h1>
      <p class="ath-brand-subtitle">Comienza tu experiencia con Andina Trade Hub</p>
    </div>
    
    <form action="/register" method="POST" onsubmit="return validateForm()" class="ath-register-form">
      <div class="ath-register-row">
        <div class="ath-register-col">
          <div class="ath-register-form-group">
            <label>Nombre</label>
            <div class="ath-register-input-wrapper">
              <i class="fas fa-user"></i>
              <input type="text" name="name" value="<%= data.name || '' %>" placeholder="Tu nombre" required>
            </div>
          </div>
        </div>
        <div class="ath-register-col">
          <div class="ath-register-form-group">
            <label>Apellido</label>
            <div class="ath-register-input-wrapper">
              <i class="fas fa-user-tag"></i>
              <input type="text" name="lastname" value="<%= data.lastname || '' %>" placeholder="Tu apellido" required>
            </div>
          </div>
        </div>
      </div>
      
      <div class="ath-register-form-group">
        <label>Fecha de Nacimiento</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-calendar-alt"></i>
          <input type="text" name="birthdate" id="birthdate" class="ath-date-input" placeholder="Selecciona tu fecha" required readonly>
        </div>
      </div>
      
      <div class="ath-register-form-group">
        <label>Email</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-envelope"></i>
          <input type="email" name="email" value="<%= data.email || '' %>" placeholder="tucorreo@ejemplo.com" required>
        </div>
      </div>
      
      <div class="ath-register-form-group">
        <label>Teléfono</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-phone"></i>
          <input type="tel" name="phone" value="<%= data.phone || '' %>" placeholder="1234567890" required>
        </div>
      </div>
      
      <div class="ath-register-form-group">
        <label>País</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-globe-americas"></i>
          <div class="custom-country-select">
            <!-- Input oculto para almacenar el valor real -->
            <input type="hidden" id="country" name="country" required>
            
            <!-- Elemento que muestra la selección actual -->
            <div class="selected-option">
             <div class="country-label">
              <span class="flag"></span>
              <span class="text">Selecciona tu país</span>
              <i class="fas fa-chevron-down"></i>
             </div>
            </div>
            
            <!-- Contenedor de opciones -->
            <div class="country-options"></div>
          </div>
        </div>
      </div>
      
      <div class="ath-register-form-group">
        <label>Contraseña</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-lock"></i>
          <input type="password" name="password" id="password" placeholder="••••••••" required oninput="checkStrength(this.value)">
        </div>
        <div id="password-strength" class="ath-password-strength"></div>
      </div>
      
      <div class="ath-register-form-group">
        <label>Confirmar contraseña</label>
        <div class="ath-register-input-wrapper">
          <i class="fas fa-lock"></i>
          <input type="password" name="confirm_password" id="confirm_password" placeholder="••••••••" required>
        </div>
      </div>
      
      <div class="ath-register-form-check">
        <input type="checkbox" class="ath-register-form-check-input" name="terms" id="terms">
        <label class="ath-register-form-check-label" for="terms">Acepto las <a href="#">políticas de privacidad</a> y <a href="#">términos de servicio</a></label>
      </div>
      
      <button type="submit" class="ath-register-btn ath-register-primary-btn" id="register-button">
        <span class="button-text">Crear cuenta</span>
        <span class="ath-register-btn-wave"></span>
      </button>
    </form>
    
    <div class="ath-register-footer">
      ¿Ya tienes cuenta? <a href="/login">Inicia sesión</a>
    </div>
  </div>
  
  <div class="ath-register-info-panel">
    <div class="ath-info-content">
      <h2>Únete a nuestra plataforma</h2>
      <ul class="ath-features-list">
        <li><i class="fas fa-chart-line"></i> Dashboard en tiempo real</li>
        <li><i class="fas fa-project-diagram"></i> Organiza tu plan de inversión</li>  
        <li><i class="fas fa-file-alt"></i> Generación de reportes</li>  
        <li><i class="fas fa-bell"></i> Alertas y notificaciones</li>  
        <li><i class="fas fa-chart-area"></i> Gráficos avanzados</li>  
      </ul>
    </div>
  </div>
</div>

<script>
// Función para cargar los países desde la API (VERSIÓN CORREGIDA)
async function loadCountries() {
  const container = document.querySelector('.country-options');
  const selectedOption = document.querySelector('.selected-option');
  const hiddenInput = document.getElementById('country');
  
  try {
    const response = await fetch('https://restcountries.com/v3.1/all?fields=name,translations,cca2,flags');
    const countries = await response.json();
    
    countries.sort((a, b) => {
    const nameA = a.translations?.spa?.common || a.name.common;
    const nameB = b.translations?.spa?.common || b.name.common;
    return nameA.localeCompare(nameB);
     });
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    countries.forEach(country => {
      const option = document.createElement('div');
      option.className = 'country-option';
      option.innerHTML = `
        <span class="flag" style="background-image: url(${country.flags.svg})"></span>
        <span class="text">${country.translations?.spa?.common || country.name.common}</span>
      `;
      
      option.addEventListener('click', () => {
        hiddenInput.value = country.cca2;
        selectedOption.querySelector('.text').textContent = country.translations?.spa?.common || country.name.common;
        selectedOption.querySelector('.flag').style.backgroundImage = `url(${country.flags.svg})`;
        container.classList.remove('show');
        selectedOption.querySelector('i').classList.remove('rotate');
      });
      
      container.appendChild(option);
    });
    
    // Manejar clic en el selector
    selectedOption.addEventListener('click', (e) => {
      e.stopPropagation();
      container.classList.toggle('show');
      selectedOption.querySelector('i').classList.toggle('rotate');
    });
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', () => {
      container.classList.remove('show');
      selectedOption.querySelector('i').classList.remove('rotate');
    });
    
  } catch (error) {
    console.error('Error al cargar los países:', error);
  }
}

document.addEventListener('DOMContentLoaded', loadCountries);

//CALENDARIO

  // Esperar a que el DOM esté completamente cargado
  document.addEventListener('DOMContentLoaded', function() {

    // Inicializar el selector de fecha
    const birthdateInput = document.getElementById('birthdate');
    if(birthdateInput) {
      // Calcular fecha máxima (hoy - 18 años)
      const today = new Date();
      const minDate = new Date();
      minDate.setFullYear(today.getFullYear() - 100); // Máximo 100 años atrás
      const maxDate = new Date();
      maxDate.setFullYear(today.getFullYear() - 18); // Mínimo 18 años atrás

      flatpickr(birthdateInput, {
        dateFormat: "Y-m-d",
        minDate: minDate,
        maxDate: maxDate,
        locale: "es",
        disableMobile: true,
        allowInput: false,
        clickOpens: true,
        theme: "light",
        onReady: function(selectedDates, dateStr, instance) {
          // Opcional: Mostrar mensaje de validación
          instance.element.setAttribute('data-message', 'Debes ser mayor de 18 años');
        }
      });
    }

    // Función para verificar fortaleza de contraseña
    window.checkStrength = function(password) {
      const strength = document.getElementById('password-strength');
      const strongRegex = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[\\W_]).{8,}$");
      
      if (password.length === 0) {
        strength.innerHTML = '';
        return;
      }
      
      if (strongRegex.test(password)) {
        strength.innerHTML = '<span class="ath-text-success"><i class="fas fa-check-circle me-1"></i> Contraseña fuerte</span>';
      } else {
        strength.innerHTML = '<span class="ath-text-danger"><i class="fas fa-exclamation-triangle me-1"></i> La contraseña debe tener al menos 8 caracteres, una mayúscula, un número y un símbolo</span>';
      }
    }

    // Función para validar el formulario
    window.validateForm = function() {
      const terms = document.getElementById('terms');
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm_password').value;
      const birthdate = document.getElementById('birthdate').value;
      const country = document.getElementById('country').value;
      
      if (!terms.checked) {
        alert('Debes aceptar las políticas de privacidad y términos de servicio.');
        return false;
      }
      
      if (!birthdate) {
        alert('Por favor selecciona tu fecha de nacimiento.');
        return false;
      }
      
      if (!country) {
        alert('Por favor selecciona tu país.');
        return false;
      }
      
      if (password !== confirmPassword) {
        alert('Las contraseñas no coinciden.');
        return false;
      }
      
      const button = document.getElementById('register-button');
      button.disabled = true;
      button.querySelector('.button-text').textContent = 'Creando cuenta...';
      button.insertAdjacentHTML('beforeend', '<i class="fas fa-spinner fa-spin ms-2"></i>');
      
      return true;
    }
  });
</script>

<style>
/* Contenedor del input y el ícono del globo */
.ath-register-input-wrapper {
  display: flex;
  align-items: center;
  gap: 12px; /* Espacio entre el ícono y el selector */
}

/* Estilo del ícono del globo */
.ath-register-input-wrapper .fa-globe-americas {
  color: #666;
  font-size: 18px;
  flex-shrink: 0;
}

/* Selector completo */
.custom-country-select {
  position: relative;
  flex-grow: 1;
}

/* Elemento que muestra el país seleccionado */
.selected-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 13px 15px;
  border: 1px solid #ddd;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  box-sizing: border-box;
}

/* Contenedor interno: bandera y texto */
.selected-option .flag {
  width: 20px;
  height: 15px;
  background-size: cover;
  background-position: center;
  display: inline-block;
}

.selected-option .text {
  flex-grow: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Flecha a la derecha */
.selected-option .fa-chevron-down {
  flex-shrink: 0;
  left: 615px;
  transition: transform 0.3s;
  margin-left: auto;
}

/* Lista desplegable */
.country-options {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 300px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 5px;
  z-index: 9999;
}

/* Cada opción del listado */
.country-option {
  padding: 10px 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
}

.country-option:hover {
  background: #f5f5f5;
}

.country-options.show {
  display: block;
}

.rotate {
  transform: rotate(180deg);
}

/* Nuevo contenedor interno */
.country-label {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: 35px; /* ✅ Aquí se mueve solo bandera + texto */
}

.flag {
  width: 20px;
  height: 15px;
  background-size: cover;
  background-position: center;
  display: inline-block;
}

.text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

</style>
